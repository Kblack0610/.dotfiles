# --- Path and Environment Variables ---

# === PATH Helper Functions ===
# Only add paths that exist and aren't already in PATH
path_prepend() {
    for dir in "$@"; do
        [ -d "$dir" ] && [[ ":$PATH:" != *":$dir:"* ]] && PATH="$dir:$PATH"
    done
}

path_append() {
    for dir in "$@"; do
        [ -d "$dir" ] && [[ ":$PATH:" != *":$dir:"* ]] && PATH="$PATH:$dir"
    done
}

# Set up local NPM packages (needs to be before PATH additions)
export NPM_PACKAGES="$HOME/.npm-packages"
export NODE_PATH="$NPM_PACKAGES/lib/node_modules:$NODE_PATH"
export NODE_ENV=development
unset MANPATH
export MANPATH="$NPM_PACKAGES/share/man:$(manpath)"

# Detect OS and set appropriate base paths
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    LIBRARY_BASE="$HOME/Library"
    JAVA_LIBRARY_BASE="$LIBRARY_BASE/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    LIBRARY_BASE="$HOME/.local/share"
    # Use default JVM or zulu-17 if available
    if [ -d "/usr/lib/jvm/zulu-17" ]; then
        JAVA_LIBRARY_BASE="/usr/lib/jvm/zulu-17"
    elif [ -d "/usr/lib/jvm/default" ]; then
        JAVA_LIBRARY_BASE="/usr/lib/jvm/default"
    else
        JAVA_LIBRARY_BASE="/usr/lib/jvm/java-25-openjdk"
    fi
fi

# Set up Android SDK
export ANDROID_HOME=$LIBRARY_BASE/Android/Sdk

# Set up Java (Zulu JDK)
export JAVA_HOME=$JAVA_LIBRARY_BASE

# Other environment variables
export MANPAGER='/usr/sbin/nvim +Man!'
export MANWIDTH=999
export XDG_CONFIG_HOME="$HOME/.config"

# === Consolidated PATH Configuration ===
# High priority (prepend) - checked for existence
path_prepend "$HOME/.local/bin"
path_prepend "$HOME/Utilities"
path_prepend "$HOME/.cargo/bin"
path_prepend "$NPM_PACKAGES/bin"

# Lower priority (append) - checked for existence
path_append "$HOME/.dotnet/tools"
path_append "$HOME/.maestro/bin"
path_append "$HOME/.spicetify"
path_append "/usr/local/go/bin"

# Android SDK paths
path_append "$ANDROID_HOME/tools"
path_append "$ANDROID_HOME/tools/bin"
path_append "$ANDROID_HOME/platform-tools"
path_append "$ANDROID_HOME/emulator"
path_append "$ANDROID_HOME/cmdline-tools/latest/bin"

# OS-specific paths
case "$(uname -s)" in
    Darwin)
        path_prepend "/opt/homebrew/bin"
        path_prepend "$HOME/.codeium/windsurf/bin"
        ;;
esac

# Export final PATH
export PATH

# Source cargo env for other settings (PATH already handled above)
[ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

# --- Sourcing Scripts ---
# NEW display a crisp prompt of: cowsay+fortune, syst info, and today tasks
# paste <(fortune | cut -c 1-200 | cowsay -W 30) <(neofetch --off --color_blocks off) <(grep -F -- "- [ ]" ~/.notes/journal/daily/$(date +%Y-%m-%d).md 2>/dev/null | head -n 15 || echo "No tasks today") | column -t -s $'\t' -o '  |  '

# paste <(fortune | cowsay -W 30) <(fastfetch --pipe --logo none) <(grep -F -- "- [ ]" ~/.notes/journal/daily/$(date +%Y-%m-%d).md 2>/dev/null | head -n 15 || echo "No tasks today") | column -t -s $'\t' -o '  |  '


# # Display a fortune cookie if cowsay is available.
# NOTE: Moved to bottom-prompt function in .zshrc for ergonomic bottom prompt
# if [ -x /usr/games/cowsay -a -x /usr/games/fortune ]; then
#     fortune | cut -c 1-200 | cowsay
# elif [ -x /usr/sbin/cowsay -a -x /usr/sbin/fortune ]; then
#     fortune | cut -c 1-200 | cowsay
# elif [ -x /opt/homebrew/bin/cowsay -a -x /opt/homebrew/bin/fortune ]; then
#     fortune | cut -c 1-200 | cowsay
# fi

# 1a. Helper: Link refs to daily note (wiki-style links)
function link_refs_to_daily() {
    local DATE=$(date +%Y-%m-%d)
    local NOTE_FILE="$HOME/.notes/journal/daily/$DATE.md"
    local REFS_DIR="$HOME/.notes/journal/refs/$DATE"

    # Skip if no refs folder or no note
    [[ ! -d "$REFS_DIR" ]] && return
    [[ ! -f "$NOTE_FILE" ]] && return

    # Get list of ref files
    local refs=($(find "$REFS_DIR" -type f -name "*.md" 2>/dev/null))
    [[ ${#refs[@]} -eq 0 ]] && return

    # Check if ## Refs section already exists
    if grep -q "^## Refs$" "$NOTE_FILE"; then
        # Section exists - check which refs are already linked
        for ref in "${refs[@]}"; do
            local name=$(basename "$ref" .md)
            local link="[[journal/refs/$DATE/$name]]"
            if ! grep -qF "$link" "$NOTE_FILE"; then
                # Add new ref link under ## Refs section
                sed -i "/^## Refs$/a - $link" "$NOTE_FILE"
            fi
        done
    else
        # Add ## Refs section at end of file
        {
            echo ""
            echo "## Refs"
            for ref in "${refs[@]}"; do
                local name=$(basename "$ref" .md)
                echo "- [[journal/refs/$DATE/$name]]"
            done
        } >> "$NOTE_FILE"
    fi
}

# 1b. Helper: Ensure the daily note exists with task carryforward + refs folder
function ensure_daily_note() {
    local DATE=$(date +%Y-%m-%d)
    local NOTE_FILE="$HOME/.notes/journal/daily/$DATE.md"
    local REFS_DIR="$HOME/.notes/journal/refs/$DATE"

    # Create refs folder for today (inside journal/)
    mkdir -p "$REFS_DIR"

    if [ ! -f "$NOTE_FILE" ]; then
        echo "Creating entry: $NOTE_FILE"
        mkdir -p "$(dirname "$NOTE_FILE")"

        # Pull carry over section from yesterday's note
        local YESTERDAY=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -v -1d +%Y-%m-%d)
        local YESTERDAY_FILE="$HOME/.notes/journal/daily/$YESTERDAY.md"
        local CARRYOVER=""
        if [ -f "$YESTERDAY_FILE" ]; then
            CARRYOVER=$(sed -n '/^## Carry Over$/,/^## /{ /^## /d; p; }' "$YESTERDAY_FILE" | sed '/^$/d')
        fi

        # Create note with clean template
        {
            echo "---"
            echo "date: $DATE"
            echo "tags: [daily]"
            echo "---"
            echo ""
            echo "# $DATE"
            echo ""
            echo "## Focus"
            echo "- [ ] "
            echo ""
            echo "## Notes"
            echo ""
            echo "## Carry Over"
            if [ -n "$CARRYOVER" ]; then
                echo "$CARRYOVER"
            fi
            echo ""
        } > "$NOTE_FILE"

        [ -n "$CARRYOVER" ] && echo "  -> Carried over persistent items"
    fi

    # Link any refs to the daily note
    link_refs_to_daily
}

# 2. Main: The Dashboard
function dashboard() {
    ensure_daily_note

    # 2. Define the Columns (Process Substitution variables)
    # Col 1: Cowsay (Removed 'cut' so words aren't sliced. 'fortune -s' keeps it short)
    local C1="fortune -s | cut -c 1-200 | cowsay -W 30"
    
    # Col 2: System (Removed '--stdout' to try and keep formatting, added '--force_color' if you switch to fastfetch)
    # Note: Standard neofetch loses color in pipes. 
    local C2="neofetch --off --color_blocks off"
    
    # Col 3: Tasks (Added --color=always so headers/matches stand out)
    local C3="grep --color=always -F -- '- [ ]' '$NOTE_FILE' 2>/dev/null | head -n 15 || echo 'No tasks yet'"

    # 3. Print based on OS
    if [[ "$(uname)" == "Darwin" ]]; then
        # MAC OS SOLUTION (Mac's 'column' doesn't support -o)
        # We use AWK to manually create the columns and draw the lines.
        paste <(eval $C1) <(eval $C2) <(eval $C3) | \
        awk -F'\t' '{printf "%-35s | %-35s | %s\n", $1, $2, $3}'
    else
        # LINUX SOLUTION (Your preferred one-liner)
        paste <(eval $C1) <(eval $C2) <(eval $C3) | \
        column -t -s $'\t' -o '  |  '
    fi
}
# --- Aliases ---

# General purpose aliases
alias nvr="nvr . -s"
alias t="smug start hub"
# alias z="zellij --layout hub"
alias n="nvim ."
alias g="git"
alias vi="nvim --listen /tmp/nvim-server.pipe"
alias refreshfontcache="fc-cache -fv"
alias e="exit"
alias lg="lazygit"
alias sysz="$HOME/.bin/sysz"
alias python="/usr/bin/python3"
alias o="nvim $HOME/.notes"

# Journal helpers (refs are inside journal/)
alias ref='cd ~/.notes/journal/refs/$(date +%Y-%m-%d) && ls -la'
alias refs="cd ~/.notes/journal/refs && ls -la"
alias today='nvim ~/.notes/journal/daily/$(date +%Y-%m-%d).md'
alias k="nvim ~/.notes/knowledge"

# Quick ref note creation (inside journal/refs/)
refnote() {
    local DATE=$(date +%Y-%m-%d)
    local NAME="${1:-note}"
    local FILE="$HOME/.notes/journal/refs/$DATE/$NAME.md"
    mkdir -p "$(dirname "$FILE")"
    nvim "$FILE"
}

# Aliases for specific tools and scripts
alias f=". $HOME/.local/src/fzf/dev.sh"
alias h=". $HOME/.local/src/fzf/history.sh"
alias db="dbconnect"
alias killUnity="kill -9 $(pgrep Unity)"

# Aliases for system commands
alias setbright="sudo brightnessctl set "
alias unmute="amixer -D pulse sset Master unmute"
alias setSound="amixer -D pulse sset Master 50%"

# Aliases for specific projects or tasks
alias gametodo="nvim $HOME/.config/life/todos/game_todo"
alias dailylog="cp $HOME/.config/life/templates/daily_log_template $HOME/.config/life/todos/log_$(date +%F)"
alias unitylaptop="env GDK_SCALE=2 ./Unity/Hub/Editor/2022.3.20f1/Editor/Unity -projectPath Games/DodginBalls/"

# --- Kubernetes Aliases ---
alias k="kubectl"
alias kx="kubectx"
alias kn="kubens"
alias kgp="kubectl get pods"
alias kgd="kubectl get deployments"
alias kgs="kubectl get services"
alias kga="kubectl get all"
alias kaf="kubectl apply -f"
alias kdf="kubectl delete -f"
alias kdp="kubectl describe pod"
alias kl="kubectl logs -f"
alias kex="kubectl exec -it"

# k9s cluster shortcuts
alias k9="k9s"
alias k9do="k9s --context do-nyc3-placemyparents-k8s-prod"
alias k9home="k9s --context home-k3s"
alias k9local="k9s --context k3d-local"

# Cluster setup
alias k8s-setup="$HOME/.local/bin/setup/k8s-clusters-setup.sh"

# Infrastructure dashboard
alias infra="$HOME/.local/src/infra-dash/display.sh"
alias infra-collect="$HOME/.local/src/infra-dash/collect.sh"
alias infra-json="$HOME/.local/src/infra-dash/display.sh -j"

# Dotfiles setup (full installation)
alias dotfiles-setup="$HOME/.local/src/installation_scripts/install.sh"

# --- Network Audio Streaming (Sunshine/Moonlight mic passthrough) ---
alias mic-stream="audio-stream --send"
alias mic-receive="audio-stream --receive"
alias mic-stop="audio-stream --stop"
alias mic-status="audio-stream --status"
alias mic-list="audio-stream --list"

alias cl="claude --dangerously-skip-permissions"
alias co="codex"
alias cb="agent" # need to rename to agent

# --- Claude Code Profiles ---
# Interactive profiles
alias cmt="claude-profile manual-test"    # Browser testing (Playwright, Docker)
alias cim="claude-profile implement"      # Coding (Serena, GitHub, Linear, Context7)
alias cfl="claude-profile full"           # All MCP servers
alias cmn="claude-profile minimal"        # Fast startup (filesystem + memory)

# Headless profiles (for scripting / calling from within Claude)
alias cmt-h="claude-profile manual-test --headless"
alias cim-h="claude-profile implement --headless"
alias cmn-h="claude-profile minimal --headless"
