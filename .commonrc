# --- Path and Environment Variables ---

# === PATH Helper Functions ===
# Only add paths that exist and aren't already in PATH
path_prepend() {
    for dir in "$@"; do
        [ -d "$dir" ] && [[ ":$PATH:" != *":$dir:"* ]] && PATH="$dir:$PATH"
    done
}

path_append() {
    for dir in "$@"; do
        [ -d "$dir" ] && [[ ":$PATH:" != *":$dir:"* ]] && PATH="$PATH:$dir"
    done
}

# Set up local NPM packages (needs to be before PATH additions)
export NPM_PACKAGES="$HOME/.npm-packages"
export NODE_PATH="$NPM_PACKAGES/lib/node_modules:$NODE_PATH"
export NODE_ENV=development
unset MANPATH
export MANPATH="$NPM_PACKAGES/share/man:$(manpath)"

# Detect OS and set appropriate base paths
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    LIBRARY_BASE="$HOME/Library"
    JAVA_LIBRARY_BASE="$LIBRARY_BASE/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    LIBRARY_BASE="$HOME/.local/share"
    # Use default JVM or zulu-17 if available
    if [ -d "/usr/lib/jvm/zulu-17" ]; then
        JAVA_LIBRARY_BASE="/usr/lib/jvm/zulu-17"
    elif [ -d "/usr/lib/jvm/default" ]; then
        JAVA_LIBRARY_BASE="/usr/lib/jvm/default"
    else
        JAVA_LIBRARY_BASE="/usr/lib/jvm/java-25-openjdk"
    fi
fi

# Set up Android SDK
export ANDROID_HOME=$LIBRARY_BASE/Android/Sdk

# Set up Java (Zulu JDK)
export JAVA_HOME=$JAVA_LIBRARY_BASE

# Other environment variables
export MANPAGER='/usr/sbin/nvim +Man!'
export MANWIDTH=999
export XDG_CONFIG_HOME="$HOME/.config"

# === Consolidated PATH Configuration ===
# High priority (prepend) - checked for existence
path_prepend "$HOME/.local/bin"
path_prepend "$HOME/Utilities"
path_prepend "$HOME/.cargo/bin"
path_prepend "$NPM_PACKAGES/bin"

# Lower priority (append) - checked for existence
path_append "$HOME/.dotnet/tools"
path_append "$HOME/.maestro/bin"
path_append "$HOME/.spicetify"
path_append "/usr/local/go/bin"

# Android SDK paths
path_append "$ANDROID_HOME/tools"
path_append "$ANDROID_HOME/tools/bin"
path_append "$ANDROID_HOME/platform-tools"

# OS-specific paths
case "$(uname -s)" in
    Darwin)
        path_prepend "/opt/homebrew/bin"
        path_prepend "$HOME/.codeium/windsurf/bin"
        ;;
esac

# Export final PATH
export PATH

# Source cargo env for other settings (PATH already handled above)
[ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

# --- Sourcing Scripts ---
# NEW display a crisp prompt of: cowsay+fortune, syst info, and today tasks
# paste <(fortune | cut -c 1-200 | cowsay -W 30) <(neofetch --off --color_blocks off) <(grep -F -- "- [ ]" ~/.notes/journal/daily/$(date +%Y-%m-%d).md 2>/dev/null | head -n 15 || echo "No tasks today") | column -t -s $'\t' -o '  |  '

# paste <(fortune | cowsay -W 30) <(fastfetch --pipe --logo none) <(grep -F -- "- [ ]" ~/.notes/journal/daily/$(date +%Y-%m-%d).md 2>/dev/null | head -n 15 || echo "No tasks today") | column -t -s $'\t' -o '  |  '


# # Display a fortune cookie if cowsay is available.
# NOTE: Moved to bottom-prompt function in .zshrc for ergonomic bottom prompt
# if [ -x /usr/games/cowsay -a -x /usr/games/fortune ]; then
#     fortune | cut -c 1-200 | cowsay
# elif [ -x /usr/sbin/cowsay -a -x /usr/sbin/fortune ]; then
#     fortune | cut -c 1-200 | cowsay
# elif [ -x /opt/homebrew/bin/cowsay -a -x /opt/homebrew/bin/fortune ]; then
#     fortune | cut -c 1-200 | cowsay
# fi

# 1. Helper: Ensure the daily note exists
function ensure_daily_note() {
    # 1. Ensure the daily note exists (Create if missing)
    local DATE=$(date +%Y-%m-%d)
    local NOTE_FILE="$HOME/.notes/journal/daily/$DATE.md"

    if [ ! -f "$NOTE_FILE" ]; then
        echo "Creating entry: $NOTE_FILE"
        mkdir -p "$(dirname "$NOTE_FILE")"
        {
            echo "# Daily Log: $DATE"
            echo ""
            echo "## Focus"
            echo "- [ ] "
            echo ""
            echo "## Notes"
        } > "$NOTE_FILE"
    fi
}

# 2. Main: The Dashboard
function dashboard() {
    ensure_daily_note

    # 2. Define the Columns (Process Substitution variables)
    # Col 1: Cowsay (Removed 'cut' so words aren't sliced. 'fortune -s' keeps it short)
    local C1="fortune -s | cut -c 1-200 | cowsay -W 30"
    
    # Col 2: System (Removed '--stdout' to try and keep formatting, added '--force_color' if you switch to fastfetch)
    # Note: Standard neofetch loses color in pipes. 
    local C2="neofetch --off --color_blocks off"
    
    # Col 3: Tasks (Added --color=always so headers/matches stand out)
    local C3="grep --color=always -F -- '- [ ]' '$NOTE_FILE' 2>/dev/null | head -n 15 || echo 'No tasks yet'"

    # 3. Print based on OS
    if [[ "$(uname)" == "Darwin" ]]; then
        # MAC OS SOLUTION (Mac's 'column' doesn't support -o)
        # We use AWK to manually create the columns and draw the lines.
        paste <(eval $C1) <(eval $C2) <(eval $C3) | \
        awk -F'\t' '{printf "%-35s | %-35s | %s\n", $1, $2, $3}'
    else
        # LINUX SOLUTION (Your preferred one-liner)
        paste <(eval $C1) <(eval $C2) <(eval $C3) | \
        column -t -s $'\t' -o '  |  '
    fi
}
# --- Aliases ---

# General purpose aliases
alias nvr="nvr . -s"
alias t="tmuxinator start hub"
# alias z="zellij --layout hub"
alias n="nvim ."
alias g="git"
alias vi="nvim --listen /tmp/nvim-server.pipe"
alias refreshfontcache="fc-cache -fv"
alias e="exit"
alias lg="lazygit"
alias sysz="$HOME/.bin/sysz"
alias python="/usr/bin/python3"
alias o="nvim $HOME/.notes"

# Aliases for specific tools and scripts
alias f=". $HOME/.local/src/fzf/dev.sh"
alias h=". $HOME/.local/src/fzf/history.sh"
alias killUnity="kill -9 $(pgrep Unity)"

# Aliases for system commands
alias setbright="sudo brightnessctl set "
alias unmute="amixer -D pulse sset Master unmute"
alias setSound="amixer -D pulse sset Master 50%"

# Aliases for specific projects or tasks
alias gametodo="nvim $HOME/.config/life/todos/game_todo"
alias dailylog="cp $HOME/.config/life/templates/daily_log_template $HOME/.config/life/todos/log_$(date +%F)"
alias unitylaptop="env GDK_SCALE=2 ./Unity/Hub/Editor/2022.3.20f1/Editor/Unity -projectPath Games/DodginBalls/"

# --- Kubernetes Aliases ---
alias k="kubectl"
alias kx="kubectx"
alias kn="kubens"
alias kgp="kubectl get pods"
alias kgd="kubectl get deployments"
alias kgs="kubectl get services"
alias kga="kubectl get all"
alias kaf="kubectl apply -f"
alias kdf="kubectl delete -f"
alias kdp="kubectl describe pod"
alias kl="kubectl logs -f"
alias kex="kubectl exec -it"

# k9s cluster shortcuts
alias k9="k9s"
alias k9do="k9s --context do-nyc3-placemyparents-k8s-prod"
alias k9home="k9s --context home-k3s"
alias k9local="k9s --context k3d-local"

# Cluster setup
alias k8s-setup="$HOME/.local/bin/setup/k8s-clusters-setup.sh"

# Dotfiles setup (full installation)
alias dotfiles-setup="$HOME/.local/src/installation_scripts/install.sh"
#
# if command -v tmux &> /dev/null && [ -n "$PS1" ] && [[ ! "$TERM" =~ screen ]] && [[ ! "$TERM" =~ tmux ]] && [ -z "$TMUX" ]; then
#   exec tmuxinator start hub
# fi

# --- Network Audio Streaming (Sunshine/Moonlight mic passthrough) ---
alias mic-stream="audio-stream --send"
alias mic-receive="audio-stream --receive"
alias mic-stop="audio-stream --stop"
alias mic-status="audio-stream --status"
alias mic-list="audio-stream --list"
