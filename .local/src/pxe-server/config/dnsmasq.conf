# PXE Boot Server - dnsmasq Configuration
# Handles TFTP server and Proxy DHCP for PXE boot
#
# This config runs dnsmasq in proxy DHCP mode, meaning your main router
# (OpenWRT) still handles IP allocation, but this server adds PXE options.

# =============================================================================
# General Settings
# =============================================================================

# Disable DNS server (we only want DHCP/TFTP)
port=0

# Logging
log-dhcp
log-facility=@@LOG_FILE@@

# =============================================================================
# Network Interface
# =============================================================================

# Bind to specific interface (auto-detected or override with PXE_INTERFACE)
interface=@@INTERFACE@@
bind-interfaces

# =============================================================================
# Proxy DHCP Mode
# =============================================================================

# Proxy DHCP - don't allocate IPs, just add PXE boot options
# OpenWRT remains the DHCP server
# Format: dhcp-range=<network>,proxy
dhcp-range=@@SUBNET@@,proxy

# =============================================================================
# TFTP Server
# =============================================================================

# Enable TFTP server
enable-tftp

# TFTP root directory (where boot files are served from)
tftp-root=@@TFTP_ROOT@@

# Note: tftp-secure removed - it requires files to be owned by the dnsmasq
# user (nobody), which conflicts with dotfiles ownership. The tftp-root
# setting already restricts access to the boot directory.

# =============================================================================
# PXE Boot - Architecture Detection
# =============================================================================

# Client architecture detection via DHCP option 93 (Client System Architecture)
# 0x00 = BIOS x86
# 0x06 = EFI IA32
# 0x07 = EFI x64 (most common UEFI)
# 0x09 = EFI x64 (alternative)

# Tag BIOS clients
dhcp-match=set:bios,option:client-arch,0

# Tag UEFI x64 clients
dhcp-match=set:efi-x64,option:client-arch,7
dhcp-match=set:efi-x64,option:client-arch,9

# Tag UEFI IA32 clients (uncommon, but some tablets)
dhcp-match=set:efi-ia32,option:client-arch,6

# =============================================================================
# Boot Files Per Architecture
# =============================================================================

# BIOS clients: Boot pxelinux which chainloads to iPXE
dhcp-boot=tag:bios,bios/pxelinux.0

# UEFI x64 clients: Boot iPXE directly
dhcp-boot=tag:efi-x64,uefi/ipxe.efi

# UEFI IA32 clients: Not commonly needed but included
dhcp-boot=tag:efi-ia32,uefi/ipxe-i386.efi

# =============================================================================
# iPXE Chainloading
# =============================================================================

# Detect if client is already iPXE (user-class contains "iPXE")
dhcp-userclass=set:ipxe,iPXE

# For iPXE clients, provide the boot script URL via option 175
# This tells iPXE where to fetch the menu script
dhcp-option=tag:ipxe,175,@@HTTP_URL@@/ipxe/menu.ipxe

# =============================================================================
# Additional Options
# =============================================================================

# Set the PXE server hostname (informational)
pxe-service=x86PC,"PXE Boot Server",bios/pxelinux

# Don't read /etc/hosts
no-hosts

# Don't read /etc/resolv.conf
no-resolv
