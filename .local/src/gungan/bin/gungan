#!/usr/bin/env bash
#
# gungan - Voice-to-text CLI using whisper-cpp
#
# Named after Jar Jar Binks - "meesa transcribe your voice!"
#
# Uses whisper-cpp (fast C++ implementation) instead of Python whisper.
# Records audio via Pipewire, transcribes, outputs to stdout AND clipboard.
#
# Usage:
#   gungan health              Check all dependencies
#   gungan test [seconds]      Quick recording test (default: 5s)
#   gungan record              Toggle: start/stop recording
#   gungan transcribe <file>   Transcribe existing .wav file
#   gungan help                Show this help
#
# Repository: https://github.com/yourusername/gungan (TODO: update)
#

set -euo pipefail

# =============================================================================
# Configuration
# =============================================================================

WHISPER_BIN="/usr/local/bin/whisper-cpp"
MODEL_DIR="${HOME}/.local/share/whisper-models"
MODEL="${MODEL_DIR}/ggml-large-v3-turbo.bin"
AUDIO_FILE="/tmp/gungan_recording.wav"
LOCK_FILE="/tmp/gungan_recording.lock"

# =============================================================================
# Colors and Output
# =============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

log_info()    { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# =============================================================================
# Helper Functions
# =============================================================================

check_dependency() {
    local name="$1"
    local path="$2"

    if [[ -x "$path" ]]; then
        log_success "$name: $path"
        return 0
    elif command -v "$name" &>/dev/null; then
        log_success "$name: $(command -v "$name")"
        return 0
    else
        log_error "$name: NOT FOUND"
        return 1
    fi
}

check_file() {
    local name="$1"
    local path="$2"

    if [[ -f "$path" ]]; then
        local size
        size=$(du -h "$path" | cut -f1)
        log_success "$name: $path ($size)"
        return 0
    else
        log_error "$name: NOT FOUND at $path"
        return 1
    fi
}

transcribe_audio() {
    local audio_file="$1"

    if [[ ! -f "$audio_file" ]]; then
        log_error "Audio file not found: $audio_file"
        return 1
    fi

    log_info "Transcribing..."

    # Run whisper-cpp and capture stdout directly
    local text
    text=$("$WHISPER_BIN" \
        -m "$MODEL" \
        -f "$audio_file" \
        -nt \
        -l en \
        -np \
        2>/dev/null | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    # Auto-punctuation: capitalize first letter, add period if missing
    if [[ -n "$text" ]]; then
        # Capitalize first letter
        text="$(echo "${text:0:1}" | tr '[:lower:]' '[:upper:]')${text:1}"
        # Add period if doesn't end with punctuation
        if [[ ! "$text" =~ [.!?]$ ]]; then
            text="${text}."
        fi
    fi

    # Output to stdout
    echo ""
    echo -e "${CYAN}━━━ Transcription ━━━${NC}"
    echo "$text"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Copy to clipboard
    if command -v wl-copy &>/dev/null; then
        echo -n "$text" | wl-copy
        log_success "Copied to clipboard"
    else
        log_warn "wl-copy not found, skipping clipboard"
    fi

    # Cleanup temp audio file
    rm -f "$audio_file" 2>/dev/null

    return 0
}

# =============================================================================
# Commands
# =============================================================================

cmd_health() {
    echo -e "${CYAN}Gungan Health Check${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━"
    echo ""

    local all_ok=true

    echo -e "${BLUE}Binaries:${NC}"
    check_dependency "whisper-cpp" "$WHISPER_BIN" || all_ok=false
    check_dependency "pw-record" "/usr/bin/pw-record" || all_ok=false
    check_dependency "wl-copy" "/usr/bin/wl-copy" || all_ok=false

    echo ""
    echo -e "${BLUE}Model:${NC}"
    check_file "ggml-large-v3-turbo" "$MODEL" || all_ok=false

    echo ""
    echo -e "${BLUE}Audio Input:${NC}"
    if command -v pactl &>/dev/null; then
        local default_source
        default_source=$(pactl get-default-source 2>/dev/null || echo "unknown")
        # Get a friendly name
        local source_desc
        source_desc=$(pactl list sources 2>/dev/null | grep -A1 "Name: ${default_source}$" | grep "Description:" | cut -d: -f2- | sed 's/^[[:space:]]*//' || echo "")
        if [[ -n "$source_desc" ]]; then
            log_success "Mic: ${source_desc}"
        else
            log_success "Mic: ${default_source}"
        fi
        echo -e "       ${YELLOW}(change with pavucontrol or: pactl set-default-source <name>)${NC}"
    else
        log_warn "pactl not found - cannot detect default microphone"
    fi

    echo ""
    if $all_ok; then
        log_success "All dependencies satisfied!"
        return 0
    else
        log_error "Some dependencies missing. See docs for installation."
        return 1
    fi
}

cmd_test() {
    local duration="${1:-5}"

    log_info "Recording for ${duration} seconds... Speak now!"
    echo ""

    # Start recording
    pw-record --format=s16 --rate=16000 --channels=1 "$AUDIO_FILE" &
    local rec_pid=$!

    # Countdown display
    for ((i=duration; i>0; i--)); do
        echo -ne "\r  ${YELLOW}Recording: ${i}s remaining...${NC}  "
        sleep 1
    done
    echo -ne "\r  ${GREEN}Recording complete!            ${NC}\n"

    # Stop recording
    kill "$rec_pid" 2>/dev/null || true
    wait "$rec_pid" 2>/dev/null || true

    # Small delay to ensure file is written
    sleep 0.3

    transcribe_audio "$AUDIO_FILE"
}

cmd_record() {
    if [[ -f "$LOCK_FILE" ]]; then
        # Stop recording
        log_info "Stopping recording..."

        # Kill pw-record
        pkill -f "pw-record.*${AUDIO_FILE}" 2>/dev/null || true

        rm -f "$LOCK_FILE"

        # Small delay to ensure file is written
        sleep 0.5

        transcribe_audio "$AUDIO_FILE"
    else
        # Start recording
        log_info "Starting recording... Run 'gungan record' again to stop."

        touch "$LOCK_FILE"

        pw-record --format=s16 --rate=16000 --channels=1 "$AUDIO_FILE" &

        log_success "Recording started (PID: $!)"
    fi
}

cmd_transcribe() {
    local file="$1"

    if [[ -z "$file" ]]; then
        log_error "Usage: gungan transcribe <audio-file>"
        return 1
    fi

    if [[ ! -f "$file" ]]; then
        log_error "File not found: $file"
        return 1
    fi

    # Don't delete the user's file, work with a copy
    local temp_file="/tmp/gungan_transcribe_$$.wav"
    cp "$file" "$temp_file"

    transcribe_audio "$temp_file"
}

show_help() {
    cat << 'EOF'
gungan - Voice-to-text CLI using whisper-cpp

USAGE:
    gungan <command> [args]

COMMANDS:
    health              Check all dependencies are installed
    test [seconds]      Quick recording test (default: 5 seconds)
    record              Toggle recording: run once to start, again to stop
    transcribe <file>   Transcribe an existing .wav audio file
    help                Show this help message

EXAMPLES:
    gungan health                 # Verify setup
    gungan test                   # 5-second test
    gungan test 10                # 10-second test
    gungan record                 # Start recording
    gungan record                 # Stop and transcribe
    gungan transcribe audio.wav   # Transcribe existing file

OUTPUT:
    Transcribed text is printed to stdout AND copied to clipboard (via wl-copy)

CONFIGURATION:
    Model: ~/.local/share/whisper-models/ggml-large-v3-turbo.bin
    Binary: /usr/local/bin/whisper-cpp

For more info, see: https://github.com/yourusername/gungan
EOF
}

# =============================================================================
# Main
# =============================================================================

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        health)
            cmd_health
            ;;
        test)
            cmd_test "$@"
            ;;
        record)
            cmd_record
            ;;
        transcribe)
            cmd_transcribe "${1:-}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $cmd"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
