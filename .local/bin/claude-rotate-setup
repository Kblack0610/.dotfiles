#!/usr/bin/env bash
# Claude Code Multi-Account Setup
# Authenticates up to 4 Claude.ai Pro/Max OAuth accounts into isolated profiles.
# Each account gets its own credential file in ~/.claude/profiles/
#
# Usage: claude-rotate-setup
set -euo pipefail

CLAUDE_DIR="$HOME/.claude"
PROFILES_DIR="$CLAUDE_DIR/profiles"
PROFILES_CONFIG="$CLAUDE_DIR/profiles-config"
ROTATION_DIR="$CLAUDE_DIR/rotation"
REAL_CLAUDE="$HOME/.local/bin/claude-real"
MAX_ACCOUNTS=4

# Ensure real binary exists
if [[ ! -x "$REAL_CLAUDE" ]]; then
    echo "Error: Claude binary not found at $REAL_CLAUDE"
    echo "Expected symlink: ~/.local/bin/claude-real -> ~/.local/share/claude/versions/X.X.X"
    exit 1
fi

# Ensure jq is available
if ! command -v jq &>/dev/null; then
    echo "Error: jq is required but not installed."
    echo "Install with: pacman -S jq"
    exit 1
fi

echo "=== Claude Code Multi-Account Setup ==="
echo ""
echo "This will authenticate up to $MAX_ACCOUNTS Claude.ai accounts."
echo "Each account opens a browser window for OAuth login."
echo "Log in with a DIFFERENT account each time."
echo ""

mkdir -p "$PROFILES_DIR" "$ROTATION_DIR"

configured=0

for i in $(seq 1 "$MAX_ACCOUNTS"); do
    CREDS_FILE="$PROFILES_DIR/${i}.credentials.json"

    if [[ -f "$CREDS_FILE" ]]; then
        sub_type=$(jq -r '.claudeAiOauth.subscriptionType // "unknown"' "$CREDS_FILE" 2>/dev/null)
        token_suffix=$(jq -r '.claudeAiOauth.accessToken // ""' "$CREDS_FILE" 2>/dev/null | tail -c 9)
        echo "Account $i: Already configured ($sub_type, token: ...$token_suffix)"
        read -rp "  Re-authenticate? [y/N] " answer
        if [[ ! "$answer" =~ ^[Yy] ]]; then
            configured=$((configured + 1))
            continue
        fi
    fi

    echo ""
    echo "--- Account $i of $MAX_ACCOUNTS ---"
    read -rp "Press Enter to open browser for login (or 's' to skip): " answer
    if [[ "$answer" == "s" ]]; then
        echo "  Skipped account $i"
        continue
    fi

    # Create isolated config dir for this account's login
    ISOLATED_DIR="$PROFILES_CONFIG/$i"
    mkdir -p "$ISOLATED_DIR"

    # Copy shared settings so login works properly
    for shared in settings.json mcp.json .mcp.json; do
        src="$CLAUDE_DIR/$shared"
        if [[ -f "$src" ]] || [[ -L "$src" ]]; then
            cp -L "$src" "$ISOLATED_DIR/$shared" 2>/dev/null || true
        fi
    done

    # Run login with isolated config dir
    echo "  Opening browser... Log in with account $i."
    CLAUDE_CONFIG_DIR="$ISOLATED_DIR" "$REAL_CLAUDE" login || {
        echo "  WARNING: Login may have failed for account $i."
        continue
    }

    # Find the credentials file (check both possible locations)
    SRC_CREDS=""
    if [[ -f "$ISOLATED_DIR/.credentials.json" ]]; then
        SRC_CREDS="$ISOLATED_DIR/.credentials.json"
    elif [[ -f "$ISOLATED_DIR/credentials.json" ]]; then
        SRC_CREDS="$ISOLATED_DIR/credentials.json"
    fi

    if [[ -n "$SRC_CREDS" ]]; then
        cp "$SRC_CREDS" "$CREDS_FILE"
        chmod 600 "$CREDS_FILE"

        sub_type=$(jq -r '.claudeAiOauth.subscriptionType // "unknown"' "$CREDS_FILE" 2>/dev/null)
        rate_tier=$(jq -r '.claudeAiOauth.rateLimitTier // "unknown"' "$CREDS_FILE" 2>/dev/null)
        token_suffix=$(jq -r '.claudeAiOauth.accessToken // ""' "$CREDS_FILE" 2>/dev/null | tail -c 9)
        echo "  Account $i authenticated: $sub_type ($rate_tier, token: ...$token_suffix)"
        configured=$((configured + 1))
    else
        echo "  WARNING: No credentials found after login for account $i."
        echo "  Checked: $ISOLATED_DIR/.credentials.json"
    fi

    echo ""
done

# Initialize rotation state
if [[ ! -f "$ROTATION_DIR/state.json" ]]; then
    echo '{"current_index": 0, "rate_limited": {}}' > "$ROTATION_DIR/state.json"
    chmod 600 "$ROTATION_DIR/state.json"
fi

echo ""
echo "=== Setup Complete ==="
echo ""
echo "Configured accounts ($configured/$MAX_ACCOUNTS):"
for i in $(seq 1 "$MAX_ACCOUNTS"); do
    CREDS_FILE="$PROFILES_DIR/${i}.credentials.json"
    if [[ -f "$CREDS_FILE" ]]; then
        sub=$(jq -r '.claudeAiOauth.subscriptionType // "unknown"' "$CREDS_FILE" 2>/dev/null)
        tier=$(jq -r '.claudeAiOauth.rateLimitTier // "unknown"' "$CREDS_FILE" 2>/dev/null)
        echo "  [$i] $sub ($tier)"
    else
        echo "  [$i] Not configured"
    fi
done
echo ""
echo "Usage:"
echo "  claude          - Auto-rotate between accounts"
echo "  claude -p 2     - Force specific account"
echo "  claude-rotate-setup  - Re-run this setup"
