#!/usr/bin/env bash
# profile-apply - Apply startup profile settings
# This script is sourced by .zprofile on TTY login
# It reads the current profile and conditionally starts Hyprland

# Profile directory locations
PROFILE_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/profile"
PROFILES_DIR="$PROFILE_DIR/profiles"
CURRENT_PROFILE="$PROFILE_DIR/current"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[profile]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[profile]${NC} $1"
}

log_error() {
    echo -e "${RED}[profile]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[profile]${NC} $1"
}

# Only run on TTY1 (primary virtual console)
# This prevents running when SSH'd in or on other TTYs
current_tty=$(tty 2>/dev/null || echo "")
if [[ "$current_tty" != "/dev/tty1" ]]; then
    return 0 2>/dev/null || exit 0
fi

# Don't run if already in a graphical session
if [[ -n "$DISPLAY" || -n "$WAYLAND_DISPLAY" ]]; then
    return 0 2>/dev/null || exit 0
fi

# Load profile settings
if [[ -f "$CURRENT_PROFILE" ]]; then
    source "$CURRENT_PROFILE"
else
    # No profile set - show available profiles and stay in terminal
    log_warn "No profile configured"
    if [[ -d "$PROFILES_DIR" ]]; then
        echo "Available profiles:"
        for profile in "$PROFILES_DIR"/*; do
            [[ -f "$profile" ]] || continue
            local name desc
            name=$(basename "$profile")
            desc=$(grep "^PROFILE_DESCRIPTION=" "$profile" 2>/dev/null | cut -d'"' -f2)
            echo "  - $name: $desc"
        done
        echo ""
        echo "Set a profile with: profile-switch <name>"
    fi
    return 0 2>/dev/null || exit 0
fi

log_info "Profile: ${PROFILE_NAME:-unknown}"

# Setup Wayland/Hyprland environment variables
setup_wayland_env() {
    export XDG_SESSION_TYPE=wayland
    export XDG_CURRENT_DESKTOP=Hyprland
    export XDG_SESSION_DESKTOP=Hyprland

    # Mozilla/Firefox Wayland
    export MOZ_ENABLE_WAYLAND=1

    # Qt Wayland
    export QT_QPA_PLATFORM=wayland
    export QT_WAYLAND_DISABLE_WINDOWDECORATION=1

    # SDL Wayland
    export SDL_VIDEODRIVER=wayland

    # Clutter (GNOME apps)
    export CLUTTER_BACKEND=wayland

    # Detect GPU and set WLR environment variables
    if [[ -x "$HOME/.local/bin/detect-gpu" ]]; then
        local gpu_info
        gpu_info=$("$HOME/.local/bin/detect-gpu" 2>/dev/null)

        if [[ -n "$gpu_info" ]]; then
            # Parse GPU info
            local gpu_type gpu_card gpu_render
            gpu_type=$(echo "$gpu_info" | grep "^TYPE=" | cut -d'=' -f2)
            gpu_card=$(echo "$gpu_info" | grep "^CARD=" | cut -d'=' -f2)
            gpu_render=$(echo "$gpu_info" | grep "^RENDER=" | cut -d'=' -f2)

            log_info "GPU: $gpu_type ($gpu_card)"

            # Set WLR device if we have a specific card
            if [[ "$gpu_card" != "none" && -e "/dev/dri/$gpu_card" ]]; then
                export WLR_DRM_DEVICES="/dev/dri/$gpu_card"
            fi

            # GPU-specific settings
            case "$gpu_type" in
                nvidia)
                    export WLR_NO_HARDWARE_CURSORS=1
                    export LIBVA_DRIVER_NAME=nvidia
                    export __GLX_VENDOR_LIBRARY_NAME=nvidia
                    export GBM_BACKEND=nvidia-drm
                    ;;
                amd)
                    export LIBVA_DRIVER_NAME=radeonsi
                    ;;
                intel)
                    export LIBVA_DRIVER_NAME=iHD
                    ;;
            esac
        fi
    fi
}

# Start Sunshine if enabled in profile (runs after Hyprland starts)
start_sunshine_if_enabled() {
    if [[ "${PROFILE_START_SUNSHINE:-false}" == "true" ]]; then
        # Delay to let Hyprland initialize, then start Sunshine
        (sleep 3 && systemctl --user start sunshine) &
    fi
}

# Handle Hyprland startup based on profile
case "$PROFILE_START_HYPRLAND" in
    true)
        log_info "Starting Hyprland via uwsm..."
        start_sunshine_if_enabled
        exec uwsm start hyprland
        ;;
    ask)
        echo ""
        echo -n "Start Hyprland? [y/N] "
        read -r response
        if [[ "$response" =~ ^[Yy] ]]; then
            log_info "Starting Hyprland via uwsm..."
            start_sunshine_if_enabled
            exec uwsm start hyprland
        else
            log_info "Staying in terminal. Run 'Hyprland' to start manually."
        fi
        ;;
    *)
        # Stay in TTY - no Hyprland
        log_info "Terminal mode. Run 'Hyprland' to start GUI manually."
        ;;
esac

# If we get here, we're staying in the terminal
# Return successfully so .zprofile continues
return 0 2>/dev/null || exit 0
