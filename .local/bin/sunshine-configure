#!/usr/bin/env bash
# sunshine-configure - Generate Sunshine configuration based on detected GPU
#
# Usage: sunshine-configure
#
# Detects the primary GPU and generates ~/.config/sunshine/sunshine.conf
# with the appropriate encoder and adapter settings.

set -euo pipefail

SUNSHINE_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/sunshine"
SUNSHINE_CONFIG="$SUNSHINE_CONFIG_DIR/sunshine.conf"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

# Find detect-gpu script
find_detect_gpu() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    if [[ -x "$script_dir/detect-gpu" ]]; then
        echo "$script_dir/detect-gpu"
    elif [[ -x "$HOME/.local/bin/detect-gpu" ]]; then
        echo "$HOME/.local/bin/detect-gpu"
    else
        return 1
    fi
}

# Run GPU detection
detect_gpu() {
    local detect_script
    if ! detect_script=$(find_detect_gpu); then
        log_error "detect-gpu script not found"
        log_error "Expected at ~/.local/bin/detect-gpu"
        exit 1
    fi

    "$detect_script"
}

# Parse detection output into variables
parse_gpu_info() {
    local gpu_info="$1"

    GPU_TYPE=$(echo "$gpu_info" | grep "^TYPE=" | cut -d= -f2 || echo "software")
    GPU_RENDER=$(echo "$gpu_info" | grep "^RENDER=" | cut -d= -f2 || echo "")
    GPU_CARD=$(echo "$gpu_info" | grep "^CARD=" | cut -d= -f2 || echo "")
    GPU_VENDOR=$(echo "$gpu_info" | grep "^VENDOR=" | cut -d= -f2 || echo "")
    GPU_CONNECTOR=$(echo "$gpu_info" | grep "^CONNECTOR=" | cut -d= -f2 || echo "")
}

# Generate configuration file
generate_config() {
    mkdir -p "$SUNSHINE_CONFIG_DIR"

    # Write header
    cat > "$SUNSHINE_CONFIG" << EOF
# Sunshine Configuration
# Generated by sunshine-configure on $(date)
# GPU Type: $GPU_TYPE
# Render Device: $GPU_RENDER
# Connector: $GPU_CONNECTOR

EOF

    # Write GPU-specific config
    case "$GPU_TYPE" in
        amd)
            cat >> "$SUNSHINE_CONFIG" << EOF
# AMD GPU - VAAPI hardware encoding
encoder = vaapi
adapter_name = $GPU_RENDER

# Output for Wayland capture (0 = first monitor)
output_name = 0
EOF
            log_info "Configured for AMD GPU with VAAPI encoder"
            ;;

        nvidia)
            cat >> "$SUNSHINE_CONFIG" << EOF
# NVIDIA GPU - NVENC hardware encoding
encoder = nvenc
adapter_name = $GPU_RENDER

# Output for Wayland capture (0 = first monitor)
output_name = 0
EOF
            log_info "Configured for NVIDIA GPU with NVENC encoder"
            ;;

        intel)
            cat >> "$SUNSHINE_CONFIG" << EOF
# Intel GPU - VAAPI hardware encoding (Quick Sync)
encoder = vaapi
adapter_name = $GPU_RENDER

# Output for Wayland capture (0 = first monitor)
output_name = 0
EOF
            log_info "Configured for Intel GPU with VAAPI encoder"
            ;;

        rpi)
            cat >> "$SUNSHINE_CONFIG" << EOF
# Raspberry Pi - V4L2M2M hardware encoding
encoder = v4l2m2m

# V4L2M2M uses kernel's built-in encoder
# No adapter_name needed
EOF
            log_info "Configured for Raspberry Pi with V4L2M2M encoder"
            ;;

        apple_silicon)
            cat >> "$SUNSHINE_CONFIG" << EOF
# Apple Silicon Mac - VideoToolbox hardware encoding
encoder = videotoolbox

# VideoToolbox uses the Apple GPU media engine
# No adapter_name needed on macOS
EOF
            log_info "Configured for Apple Silicon with VideoToolbox encoder"
            ;;

        intel_mac|intel_mac_amd|intel_mac_nvidia)
            cat >> "$SUNSHINE_CONFIG" << EOF
# Intel Mac - VideoToolbox hardware encoding
encoder = videotoolbox

# VideoToolbox uses available hardware encoders
# No adapter_name needed on macOS
EOF
            log_info "Configured for Intel Mac with VideoToolbox encoder"
            ;;

        software|*)
            cat >> "$SUNSHINE_CONFIG" << EOF
# Software encoding (fallback - no hardware acceleration)
encoder = software

# Note: Software encoding is CPU-intensive
# Consider installing appropriate GPU drivers for hardware acceleration
EOF
            log_warning "Using software encoding - no supported GPU detected"
            log_warning "This will be CPU-intensive. Install GPU drivers for better performance."
            ;;
    esac

    log_info "Configuration written to $SUNSHINE_CONFIG"
}

# Show current configuration
show_config() {
    echo ""
    log_info "Generated configuration:"
    echo "----------------------------------------"
    cat "$SUNSHINE_CONFIG"
    echo "----------------------------------------"
}

# Main
main() {
    log_info "Detecting GPU..."

    local gpu_info
    if ! gpu_info=$(detect_gpu 2>/dev/null); then
        log_warning "GPU detection returned an error, using fallback"
        gpu_info="TYPE=software"
    fi

    parse_gpu_info "$gpu_info"

    log_info "Detected GPU type: $GPU_TYPE"
    [[ -n "$GPU_RENDER" && "$GPU_RENDER" != "none" ]] && log_info "Render device: $GPU_RENDER"
    [[ -n "$GPU_CONNECTOR" && "$GPU_CONNECTOR" != "none" ]] && log_info "Active connector: $GPU_CONNECTOR"

    generate_config
    show_config

    echo ""
    log_info "To apply changes, restart Sunshine:"
    log_info "  systemctl --user restart sunshine"
}

main "$@"
